<div class="inv-shell">
  <!-- Top Bar -->
  <header class="topbar">
    <div class="brand">
      <img src="assets/comp-nobg.png" alt="company logo">
      <h1>Manage Inventory</h1>
    </div>

    <div class="nav-buttons">
      <button routerLink="/" class="btn btn-secondary">üè† Home</button>
      <button routerLink="/login" class="btn btn-secondaryT">üîê Admin Dashboard</button>
      <button (click)="logout()" class="btn btn-danger">üö™ Logout</button>
    </div>
  </header>

  <main class="content">

    <!-- Add Product Card -->
    <section class="card add-product">
      <div class="card-head">
        <h3>Add Product</h3>
        <p class="muted">Create a new product and optionally attach an image.</p>
      </div>

      <div class="form-grid">
        <label class="field">
          <span>Name</span>
          <input type="text" placeholder="e.g. 10mm Hex Bolt"
            [(ngModel)]="newProduct.name"
            (ngModelChange)="validateAdd()"
            [class.invalid]="!!addErrors.name"
          />
          <small class="err" *ngIf="addErrors.name">{{ addErrors.name }}</small>
        </label>

        <label class="field">
          <span>Price</span>
          <input type="number" placeholder="e.g. 24.99" min="0.01" step="0.01" inputmode="decimal"
            [(ngModel)]="newProduct.price"
            (ngModelChange)="validateAdd()"
            [class.invalid]="!!addErrors.price"
          />
          <small class="err" *ngIf="addErrors.price">{{ addErrors.price }}</small>
        </label>

        <label class="field">
          <span>Quantity</span>
          <input type="number" placeholder="e.g. 100" min="0" step="1" inputmode="numeric"
            [(ngModel)]="newProduct.qty"
            (ngModelChange)="validateAdd()"
            [class.invalid]="!!addErrors.qty"
          />
          <small class="err" *ngIf="addErrors.qty">{{ addErrors.qty }}</small>
        </label>

        <label class="field field-span2">
          <span>Description <em class="muted">(optional)</em></span>
          <input type="text" placeholder="Short description"
            [(ngModel)]="newProduct.description"
          />
        </label>

        <div class="field field-span2">
          <span>Image <em class="muted">(optional)</em></span>
          <input class="file-input" type="file"
            accept=".jpg,.jpeg,.png,image/jpeg,image/png"
            (change)="handleImageUpload($event)"
          />
          <p class="hint">Accepted: JPG or PNG</p>
        </div>
      </div>

      <!-- Image preview -->
      <div *ngIf="addPreviewUrl" class="preview-wrap">
        <img [src]="addPreviewUrl" class="preview-img" />
        <div class="preview-actions">
          <button class="btn btn-secondary" (click)="triggerAddReupload()">Choose different file</button>
          <button class="btn btn-ghost" (click)="cancelAddImage()">Cancel image</button>
        </div>
      </div>

      <!-- Warning -->
      <div *ngIf="showAddImageWarning" class="callout warn">
        <div class="callout-body">
          <strong>No image selected.</strong> Create product without an image?
        </div>
        <div class="callout-actions">
          <button class="btn btn-primary" (click)="proceedWithoutImage()">Yes, continue</button>
          <button class="btn btn-ghost" (click)="showAddImageWarning = false">Cancel</button>
        </div>
      </div>

      <input #addReuploadInput type="file"
        accept=".jpg,.jpeg,.png,image/jpeg,image/png"
        (change)="handleImageUpload($event)"
        style="display: none"
      />

      <div class="actions">
        <button class="btn btn-primary" (click)="addProduct()" [disabled]="!addFormValid">Add Product</button>
      </div>
    </section>

    <!-- Product List -->
    <section class="card">
      <div class="card-head">
        <h3>Products</h3>
        <p class="muted" *ngIf="!products.length">No products yet. Add your first one above.</p>
      </div>

      <div class="table-wrap" *ngIf="products.length">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sticky">Variants</th>
              <th class="sticky">ID</th>
              <th class="sticky">Name</th>
              <th class="sticky">Description</th>
              <th class="sticky">Price</th>
              <th class="sticky">Qty</th>
              <th class="sticky">Image</th>
              <th class="sticky">Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let product of products">
              <td>
                <button class="btn btn-secondary" (click)="selectProduct(product)">Variants</button>
              </td>

              <td><span class="badge">#{{ product.id }}</span></td>
              <td class="t-left">{{ product.name }}</td>

              <td class="t-left ellipsize" title="{{ product.description }}">
                {{ product.description }}
              </td>

              <td>\${{ product.price }}</td>
              <td>{{ product.qty }}</td>

              <td>
                <img [src]="getImageUrl(product.imageURL)" class="product-img" alt="product image" />
              </td>

              <td>
                <div class="row-actions">
                  <button class="btn btn-warning" (click)="editProduct(product)">Edit</button>
                  <button class="btn btn-danger" (click)="deleteProduct(product.id)">Delete</button>
                </div>
              </td>
            </tr>
          </tbody>

        </table>
      </div>
    </section>

    <!-- VARIANT LIST MODAL -->
    <div class="admin-modal-overlay" *ngIf="selectedProductForVariant" (click)="closeVariantModal()">
      <div class="admin-modal card" (click)="$event.stopPropagation()">

        <div class="card-head modal-header">
          <h3>Variants for {{ selectedProductForVariant.name }}</h3>
          <button class="close-btn" (click)="closeVariantModal()">‚úï</button>
        </div>

        <div class="modal-body">

          <div class="form-grid">
            <label class="field">
              <span>Size</span>
              <input type="text" [(ngModel)]="newVariant.size" />
            </label>

            <label class="field">
              <span>Length</span>
              <input type="text" [(ngModel)]="newVariant.length" />
            </label>

            <label class="field">
              <span>Price</span>
              <input type="number" min="0" step="0.01" [(ngModel)]="newVariant.price" />
            </label>

            <label class="field">
              <span>Qty</span>
              <input type="number" min="0" step="1" [(ngModel)]="newVariant.qty" />
            </label>

            <button class="btn btn-primary" (click)="addVariant()">Add Variant</button>
          </div>

          <table class="data-table" *ngIf="variants.length">
            <thead>
              <tr>
                <th>Size</th>
                <th>Length</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let v of variants">
                <td>{{ v.size }}</td>
                <td>{{ v.length_value }}</td>
                <td>\${{ v.price }}</td>
                <td>{{ v.qty }}</td>
                <td>
                  <button class="btn btn-warning" (click)="editingVariant = v">Edit</button>
                  <button class="btn btn-danger" (click)="deleteVariant(v.id)">Delete</button>
                </td>
              </tr>
            </tbody>
          </table>

        </div>
      </div>
    </div>

    <!-- EDIT VARIANT MODAL -->
    <div class="admin-modal-overlay" *ngIf="editingVariant" (click)="editingVariant = null">
      <div class="admin-modal card" (click)="$event.stopPropagation()">

        <div class="card-head modal-header">
          <h3>Edit Variant: {{ editingVariant.size }} ({{ editingVariant.length_value }})</h3>
          <button class="close-btn" (click)="editingVariant = null">‚úï</button>
        </div>

        <div class="modal-body">

          <div class="form-grid">
            <label class="field">
              <span>Size</span>
              <input type="text" [(ngModel)]="editingVariant.size" />
            </label>

            <label class="field">
              <span>Length</span>
              <input type="text" [(ngModel)]="editingVariant.length_value" />
            </label>

            <label class="field">
              <span>Price</span>
              <input type="number" min="0" step="0.01" [(ngModel)]="editingVariant.price" />
            </label>

            <label class="field">
              <span>Qty</span>
              <input type="number" min="0" step="1" [(ngModel)]="editingVariant.qty" />
            </label>

            <button class="btn btn-primary" (click)="saveVariant()">Save</button>
            <button class="btn btn-ghost" (click)="editingVariant = null">Cancel</button>
          </div>
        </div>

      </div>
    </div>

    <!-- EDIT PRODUCT MODAL -->
    <div class="admin-modal-overlay" *ngIf="editingProduct" (click)="closeEditProduct()">
      <div class="admin-modal card" (click)="$event.stopPropagation()">

        <div class="card-head modal-header">
          <h3>Edit Product</h3>
          <button class="close-btn" (click)="closeEditProduct()">‚úï</button>
        </div>

        <div class="modal-body">

          <div class="form-grid">
            <label class="field">
              <span>Name</span>
              <input type="text"
                [(ngModel)]="editingProduct.name"
                (ngModelChange)="validateEdit()"
                [class.invalid]="!!editErrors.name"
              />
              <small class="err" *ngIf="editErrors.name">{{ editErrors.name }}</small>
            </label>

            <label class="field">
              <span>Price</span>
              <input type="number" min="0.01" step="0.01" inputmode="decimal"
                [(ngModel)]="editingProduct.price"
                (ngModelChange)="validateEdit()"
                [class.invalid]="!!editErrors.price"
              />
              <small class="err" *ngIf="editErrors.price">{{ editErrors.price }}</small>
            </label>

            <label class="field">
              <span>Quantity</span>
              <input type="number" min="0" step="1" inputmode="numeric"
                [(ngModel)]="editingProduct.qty"
                (ngModelChange)="validateEdit()"
                [class.invalid]="!!editErrors.qty"
              />
              <small class="err" *ngIf="editErrors.qty">{{ editErrors.qty }}</small>
            </label>

            <label class="field field-span2">
              <span>Description <em class="muted">(optional)</em></span>
              <input type="text" [(ngModel)]="editingProduct.description" />
            </label>

            <div class="field field-span2">
              <span>New Image <em class="muted">(optional)</em></span>
              <input class="file-input" type="file"
                accept=".jpg,.jpeg,.png,image/jpeg,image/png"
                (change)="handleEditImageUpload($event)"
              />
              <p class="hint">Leave blank to keep existing image.</p>
            </div>
          </div>

          <!-- Preview -->
          <div *ngIf="editPreviewUrl" class="preview-wrap">
            <img [src]="editPreviewUrl" class="preview-img" />
            <div class="preview-actions">
              <button class="btn btn-secondary" (click)="triggerEditReupload()">Choose different file</button>
              <button class="btn btn-ghost" (click)="cancelEditImage()">Cancel image</button>
            </div>
          </div>

          <input #editReuploadInput
            type="file"
            accept=".jpg,.jpeg,.png,image/jpeg,image/png"
            (change)="handleEditImageUpload($event)"
            style="display: none"
          />

          <!-- Additional Images -->
          <section class="product-images-section">
            <h4>Additional Images</h4>

            <input #additionalImagesInput
              type="file"
              multiple
              accept="image/jpeg,image/png"
              style="display: none"
              (change)="onSelectAdditionalImages($event)"
            />

            <div class="row-actions">
              <button class="btn btn-secondary" (click)="triggerAdditionalImageSelect()">üì∏ Select Images</button>
              <button class="btn btn-primary"
                (click)="uploadSelectedAdditionalImages()"
                [disabled]="!pendingAdditionalFiles.length">
                ‚è´ Upload Selected ({{ pendingAdditionalFiles.length }})
              </button>
            </div>

            <div class="image-grid" *ngIf="pendingAdditionalFiles.length">
              <div *ngFor="let file of pendingAdditionalFiles" class="image-item">
                <img [src]="file.preview" class="extra-img-preview" />
                <p class="muted">{{ file.file.name }}</p>
              </div>
            </div>

            <hr />

            <h4>Existing Images</h4>
            <div class="image-grid" *ngIf="editingProductImages.length">
              <div *ngFor="let img of editingProductImages" class="image-item">
                <img [src]="getImageUrl(img.image_path)" class="extra-img-preview" />
                <button class="btn btn-danger small" (click)="deleteAdditionalImage(img)">üóë Delete</button>
              </div>
            </div>

            <p class="muted" *ngIf="editingProductImages.length === 0">No additional images uploaded yet.</p>
          </section>

        </div>

        <div class="modal-actions">
          <button class="btn btn-primary" (click)="saveEdit()" [disabled]="!editFormValid">Save</button>
          <button class="btn btn-ghost" (click)="closeEditProduct()">Cancel</button>
        </div>

      </div>
    </div>
  </main>
</div>
