<div class="inv-shell">
  <!-- Top Bar -->
  <header class="topbar">
    <div class="brand">
      <img src="assets/comp-nobg.png" alt="company logo">
      <h1>Manage Orders</h1>
    </div>

    <div class="nav-buttons">
      <button routerLink="/" class="btn btn-secondary">üè† Home</button>
      <button routerLink="/login" class="btn btn-secondaryT">üîê Admin Dashboard</button>
      <button (click)="logout()" class="btn btn-danger">üö™ Logout</button>
    </div>
  </header>

  <main class="content">

    <!-- Filters / Search -->
    <section class="card">
      <div class="card-head">
        <h3>Order Filters</h3>
      </div>

      <div class="form-grid">
        <label class="field field-span2">
          <span>Search</span>
          <input type="text" [(ngModel)]="searchTerm" placeholder="Search by ID, customer, or item..." />
        </label>

        <label class="field">
          <span>Status</span>
          <select [(ngModel)]="filterStatus">
            <option value="All">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </label>

        <label class="field">
          <span>Sort</span>
          <button class="btn btn-secondary" (click)="sortNewestFirst = !sortNewestFirst">
            {{ sortNewestFirst ? 'Newest ‚Üí Oldest' : 'Oldest ‚Üí Newest' }}
          </button>
        </label>

        <button class="btn btn-primary" (click)="downloadCSV()">
          Export CSV
        </button>
      </div>
    </section>

    <!-- Orders Table -->
    <section class="card">
      <div class="card-head">
        <h3>Orders</h3>
        <p class="muted" *ngIf="!filteredOrders.length">No orders found.</p>
      </div>

      <div class="table-wrap" *ngIf="filteredOrders.length">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sticky">ID</th>
              <th class="sticky">Customer</th>
              <th class="sticky">Items</th>
              <th class="sticky">Amount</th>
              <th class="sticky">Method</th>
              <th class="sticky">Date</th>
              <th class="sticky">Status</th>

              <!-- NEW: Reference column header -->
              <th class="sticky">Reference</th>

              <th class="sticky">Actions</th>
              <th class="sticky">History</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let o of filteredOrders">
              <td><span class="badge">#{{ o.id }}</span></td>

              <td class="t-left">
                <div>{{ o.customerName }}</div>
                <div class="muted">{{ o.email }} ‚Ä¢ {{ o.phone }}</div>
              </td>

              <td>{{ o.items }}</td>
              <td class="t-right">
                {{ o.amount | currency:(o.currency || 'CAD'):'symbol-narrow':'1.2-2' }}
              </td>

              <td>{{ o.method || '‚Äî' }}</td>
              <td>{{ o.date }}</td>

              <td>
                <span [ngClass]="statusClass(o.status)">{{ o.status }}</span>
              </td>

              <!-- NEW: Reference number (only when Pending) -->
              <td>
                <ng-container *ngIf="o.status === 'Pending'; else blankRef">
                  <span class="ref-pill">{{ o.reference || '‚Äî' }}</span>
                </ng-container>

                <ng-template #blankRef>
                  ‚Äî
                </ng-template>
              </td>

              <td class="row-actions">
                <button class="btn btn-warning" (click)="openDetails(o)">View</button>
                <button class="btn btn-primary" *ngIf="!o._editing" (click)="beginEdit(o)">Edit</button>

                <div *ngIf="o._editing" class="row-actions">
                  <select [(ngModel)]="o._pendingStatus">
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                  <button class="btn btn-primary" (click)="saveEdit(o)">Save</button>
                  <button class="btn btn-ghost" (click)="cancelEdit(o)">Cancel</button>
                </div>
              </td>

              <td class="history">
                <ng-container *ngIf="o.history.length; else noHist">
                  <div *ngFor="let h of o.history">‚Ä¢ {{ h }}</div>
                </ng-container>

                <ng-template #noHist>‚Ä¢ No changes yet</ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Modal Overlay -->
    <div class="admin-modal-overlay" *ngIf="selected" (click)="closeDetails()">
      <div class="admin-modal card" (click)="$event.stopPropagation()">
        <div class="card-head modal-header">
          <h3>Order Details ‚Äì {{ selected.id }}</h3>
          <button class="close-btn" (click)="closeDetails()">‚úï</button>
        </div>

        <div class="modal-body">
          <!-- Customer -->
          <section class="modal-section">
            <h4>Customer</h4>
            <p><strong>Name:</strong> {{ selected.customerName }}</p>
            <p><strong>Email:</strong> {{ selected.email }}</p>
            <p><strong>Phone:</strong> {{ selected.phone || '‚Äî' }}</p>
          </section>

          <!-- Address -->
          <section class="modal-section">
            <h4>Address</h4>
            <p>{{ selected.address || '‚Äî' }}</p>
            <p *ngIf="selected.city || selected.postalCode">
              {{ selected.city || '' }}
              <span *ngIf="selected.city && selected.postalCode"> ‚Ä¢ </span>
              {{ selected.postalCode || '' }}
            </p>
          </section>

          <!-- Payment -->
          <section class="modal-section">
            <h4>Payment & Status</h4>
            <p><strong>Method:</strong> {{ selected.method || '‚Äî' }}</p>
            <p><strong>Status:</strong> {{ selected.status }}</p>
            <p><strong>Date:</strong> {{ selected.date }}</p>
            <p>
              <strong>Amount:</strong>
              {{ selected.amount | currency:(selected.currency || 'CAD'):'symbol-narrow':'1.2-2' }}
            </p>
            <p><strong>Reference:</strong> {{ selected.reference || '‚Äî' }}</p>
          </section>

          <!-- Items -->
          <section class="modal-section">
            <h4>Items</h4>
            <p>{{ selected.items }}</p>
          </section>

          <!-- Notes -->
          <section class="modal-section">
            <h4>Notes</h4>
            <p>{{ selected.notes || '‚Äî' }}</p>
          </section>
        </div>
        <section class="modal-section">
          <h4>History</h4>

          <ng-container *ngIf="selected.history?.length; else noHistModal">
            <div *ngFor="let h of selected.history">
              ‚Ä¢ {{ h }}
            </div>
          </ng-container>

          <ng-template #noHistModal>
            <p>‚Äî No history yet</p>
          </ng-template>
        </section>


        <div class="modal-actions">
          <button class="btn btn-ghost" (click)="closeDetails()">Close</button>
        </div>
      </div>
    </div>


  </main>
</div>