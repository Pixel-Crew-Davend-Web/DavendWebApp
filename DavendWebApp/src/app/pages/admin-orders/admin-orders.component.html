<div class="inv-shell">
  <!-- Top Bar -->
  <header class="topbar">
    <div class="brand">
      <span class="logo-dot"></span>
      <h1>Manage Orders</h1>
    </div>

    <div class="nav-buttons">
      <button routerLink="/" class="btn btn-secondary">ğŸ  Home</button>
      <button routerLink="/login" class="btn btn-secondaryT">ğŸ” Admin Dashboard</button>
      <button (click)="logout()" class="btn btn-danger">ğŸšª Logout</button>
    </div>
  </header>

  <main class="content">

    <!-- Filters / Search -->
    <section class="card">
      <div class="card-head">
        <h3>Order Filters</h3>
      </div>

      <div class="form-grid">
        <label class="field field-span2">
          <span>Search</span>
          <input type="text"
                 [(ngModel)]="searchTerm"
                 placeholder="Search by ID, customer, or item..." />
        </label>

        <label class="field">
          <span>Status</span>
          <select [(ngModel)]="filterStatus">
            <option value="All">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </label>

        <label class="field">
          <span>Sort</span>
          <button class="btn btn-secondary"
                  (click)="sortNewestFirst = !sortNewestFirst">
            {{ sortNewestFirst ? 'Newest â†’ Oldest' : 'Oldest â†’ Newest' }}
          </button>
        </label>

        <button class="btn btn-primary" (click)="downloadCSV()">
          Export CSV
        </button>
      </div>
    </section>

    <!-- Orders Table -->
    <section class="card">
      <div class="card-head">
        <h3>Orders</h3>
        <p class="muted" *ngIf="!filteredOrders.length">No orders found.</p>
      </div>

      <div class="table-wrap" *ngIf="filteredOrders.length">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sticky">ID</th>
              <th class="sticky">Customer</th>
              <th class="sticky">Items</th>
              <th class="sticky">Method</th>
              <th class="sticky">Date</th>
              <th class="sticky">Status</th>

              <!-- NEW: Reference column header -->
              <th class="sticky">Reference</th>

              <th class="sticky">Actions</th>
              <th class="sticky">History</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let o of filteredOrders">
              <td><span class="badge">#{{ o.id }}</span></td>

              <td class="t-left">
                <div>{{ o.customerName }}</div>
                <div class="muted">{{ o.email }} â€¢ {{ o.phone }}</div>
              </td>

              <td>{{ o.items }}</td>
              <td>{{ o.method || 'â€”' }}</td>
              <td>{{ o.date }}</td>

              <td>
                <span [ngClass]="statusClass(o.status)">{{ o.status }}</span>
              </td>

              <!-- NEW: Reference number (only when Pending) -->
              <td>
                <ng-container *ngIf="o.status === 'Pending'; else blankRef">
                  <span class="ref-pill">{{ o.reference || 'â€”' }}</span>
                </ng-container>

                <ng-template #blankRef>
                  â€”
                </ng-template>
              </td>

              <td class="row-actions">
                <button class="btn btn-warning" (click)="openDetails(o)">View</button>
                <button class="btn btn-primary" *ngIf="!o._editing" (click)="beginEdit(o)">Edit</button>

                <div *ngIf="o._editing" class="row-actions">
                  <select [(ngModel)]="o._pendingStatus">
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                  <button class="btn btn-primary" (click)="saveEdit(o)">Save</button>
                  <button class="btn btn-ghost" (click)="cancelEdit(o)">Cancel</button>
                </div>
              </td>

              <td class="history">
                <ng-container *ngIf="o.history.length; else noHist">
                  <div *ngFor="let h of o.history">â€¢ {{ h }}</div>
                </ng-container>

                <ng-template #noHist>â€¢ No changes yet</ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Modal -->
    <div class="card modal" *ngIf="selected">
      <div class="card-head">
        <h3>Order Details â€“ {{ selected.id }}</h3>
      </div>

      <p><strong>Customer:</strong> {{ selected.customerName }}</p>
      <p><strong>Email:</strong> {{ selected.email }}</p>
      <p><strong>Phone:</strong> {{ selected.phone }}</p>
      <p><strong>Items:</strong> {{ selected.items }}</p>
      <p><strong>Method:</strong> {{ selected.method || 'â€”' }}</p>
      <p><strong>Date:</strong> {{ selected.date }}</p>
      <p><strong>Status:</strong> {{ selected.status }}</p>

      <!-- NEW: Show reference inside modal too -->
      <p><strong>Reference:</strong> {{ selected.reference || 'â€”' }}</p>

      <p><strong>Notes:</strong> {{ selected.notes || 'â€”' }}</p>

      <div class="actions">
        <button class="btn btn-ghost" (click)="closeDetails()">Close</button>
      </div>
    </div>

  </main>
</div>
