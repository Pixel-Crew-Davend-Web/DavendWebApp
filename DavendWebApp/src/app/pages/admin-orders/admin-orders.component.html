<div class="orders-container">
  <div class="orders-header">
    <h2>Manage Customer Orders</h2>

    <div class="controls">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        placeholder="Search by ID, customer, or item..."
      />

      <select [(ngModel)]="filterStatus">
        <option value="All">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>

      <button (click)="sortNewestFirst = !sortNewestFirst">
        Sort: {{ sortNewestFirst ? 'Newest → Oldest' : 'Oldest → Newest' }}
      </button>

      <button class="export" (click)="downloadCSV()">Export CSV</button>
      <button class="home" (click)="goHome()">Home</button>
      <button class="logout" (click)="logout()">Logout</button>
    </div>
  </div>

  <table class="orders-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Customer</th>
        <th>Items</th>
        <th>Method</th>
        <th>Reference</th>
        <th>Date</th>
        <th>Status</th>
        <th>Notes</th>
        <th>Actions</th>
        <th>History</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let o of filteredOrders">
        <td>{{ o.id }}</td>

        <td>
          <div class="cust-name">{{ o.customerName }}</div>
          <div class="cust-meta">{{ o.email }} • {{ o.phone }}</div>
        </td>

        <td>{{ o.items }}</td>
        <td>{{ o.method || '—' }}</td>
        <td>{{ o.reference || '—' }}</td>
        <td>{{ o.date }}</td>

        <td>
          <span [ngClass]="statusClass(o.status)">
            {{ o.status }}
          </span>
        </td>

        <td class="notes">
          {{ o.notes || '—' }}
        </td>
 
        <td class="actions">
          <button class="view" (click)="openDetails(o)">View</button>
          <button class="edit" (click)="beginEdit(o)" *ngIf="!o._editing">
            Edit
          </button>

          <div *ngIf="o._editing" class="edit-controls">
            <select [(ngModel)]="o._pendingStatus">
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>

            <button class="save" (click)="saveEdit(o)">Save</button>
            <button class="cancel" (click)="cancelEdit(o)">Cancel</button>
          </div>
        </td>

        <td class="history">
          <div *ngIf="o.history.length; else noHist">
            <div *ngFor="let h of o.history">• {{ h }}</div>
          </div>

          <ng-template #noHist>• No changes yet</ng-template>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Details Modal -->
  <div class="modal-backdrop" *ngIf="selected">
    <div class="modal">
      <div class="modal-header">
        <h3>Order Details – {{ selected.id }}</h3>
      </div>

      <div class="modal-body">
        <p><strong>Customer:</strong> {{ selected.customerName }}</p>
        <p><strong>Email:</strong> {{ selected.email }}</p>
        <p><strong>Phone:</strong> {{ selected.phone }}</p>
        <p><strong>Items:</strong> {{ selected.items }}</p>
        <p><strong>Method:</strong> {{ selected.method || '—' }}</p>

        <!-- Added reference inside modal -->
        <p><strong>Reference:</strong> {{ selected.reference || '—' }}</p>

        <p><strong>Date:</strong> {{ selected.date }}</p>
        <p><strong>Status:</strong> {{ selected.status }}</p>
        <p><strong>Notes:</strong> {{ selected.notes || '—' }}</p>
      </div>

      <div class="modal-footer">
        <button (click)="closeDetails()">Close</button>
      </div>
    </div>
  </div>
</div>
